{% extends "base.html" %}

{% block title %}Call Analysis - AI Call Auditor{% endblock %}

{% block content %}
<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
    <div>
        <h1 class="page-title">Call Analysis Report</h1>
        <p class="page-subtitle" id="callId">Loading...</p>
    </div>
    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
        <a href="/upload" class="btn btn-primary">
            <i class="fas fa-plus"></i>
            Upload New Call
        </a>
        <button id="deleteRecordingBtn" class="btn btn-warning" style="display: none;" onclick="deleteRecording()">
            <i class="fas fa-trash-alt"></i>
            Delete Recording
        </button>
        <button id="deleteCallBtn" class="btn btn-danger" style="display: none;" onclick="deleteCall()">
            <i class="fas fa-trash"></i>
            Delete Call
        </button>
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Back to Dashboard
        </a>
    </div>
</div>

<div id="callContent">
    <div class="loading-overlay" style="position: relative; background: transparent; min-height: 400px;">
        <div class="spinner"></div>
        <div class="loading-text">Loading analysis...</div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Confirm Delete</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="modalMessage">Are you sure you want to delete this?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<style>
.btn-warning {
    background: linear-gradient(135deg, #F59E0B, #D97706);
    color: white;
}
.btn-warning:hover {
    background: linear-gradient(135deg, #D97706, #B45309);
    transform: translateY(-2px);
}
.btn-danger {
    background: linear-gradient(135deg, #EF4444, #DC2626);
    color: white;
}
.btn-danger:hover {
    background: linear-gradient(135deg, #DC2626, #B91C1C);
    transform: translateY(-2px);
}
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}
.modal-content {
    background: var(--bg-card);
    border-radius: 16px;
    width: 90%;
    max-width: 400px;
    border: 1px solid var(--border);
    animation: modalSlideIn 0.2s ease-out;
}
@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: scale(0.95) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--border);
}
.modal-header h3 {
    margin: 0;
    font-size: 1.125rem;
}
.modal-close {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0;
    line-height: 1;
}
.modal-close:hover {
    color: var(--text-primary);
}
.modal-body {
    padding: 1.5rem;
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
}
.audio-player-card {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-card));
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
}
.audio-player-card h4 {
    margin: 0 0 0.75rem 0;
    font-size: 0.875rem;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.audio-player-card audio {
    width: 100%;
    height: 40px;
    border-radius: 8px;
}
.recording-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: var(--text-muted);
}
.recording-expired {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #EF4444;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
const callId = '{{ call_id }}';
let currentCall = null;

async function loadCallDetail() {
    try {
        const response = await fetch(`/api/calls/${callId}`);
        if (!response.ok) {
            throw new Error('Call not found');
        }
        
        const call = await response.json();
        currentCall = call;
        renderCallDetail(call);
        
        // Show action buttons
        document.getElementById('deleteCallBtn').style.display = 'inline-flex';
        
        // Load audio player
        loadAudioPlayer();
        
    } catch (error) {
        document.getElementById('callContent').innerHTML = `
            <div class="info-card" style="text-align: center; padding: 3rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üòï</div>
                <h3 style="margin-bottom: 0.5rem;">Call Not Found</h3>
                <p style="color: var(--text-secondary);">${error.message}</p>
                <a href="/" class="btn btn-primary" style="margin-top: 1rem;">
                    Go to Dashboard
                </a>
            </div>
        `;
    }
}

async function loadAudioPlayer() {
    const audioContainer = document.getElementById('audioPlayerContainer');
    if (!audioContainer) return;
    
    try {
        const response = await fetch(`/api/calls/${callId}/audio-url`);
        
        if (response.status === 410) {
            // Recording expired
            audioContainer.innerHTML = `
                <div class="recording-expired">
                    <i class="fas fa-exclamation-triangle"></i>
                    Recording has expired and been automatically deleted
                </div>
            `;
            return;
        }
        
        if (response.status === 404) {
            // No recording available
            audioContainer.innerHTML = `
                <div style="color: var(--text-muted); font-size: 0.875rem; padding: 0.5rem 0;">
                    <i class="fas fa-info-circle"></i> No audio recording available
                </div>
            `;
            return;
        }
        
        if (!response.ok) {
            throw new Error('Failed to load audio');
        }
        
        const data = await response.json();
        
        // Show delete recording button
        document.getElementById('deleteRecordingBtn').style.display = 'inline-flex';
        
        // Calculate time remaining
        let expiryInfo = '';
        if (data.expires_at) {
            const expiresAt = new Date(data.expires_at);
            const now = new Date();
            const hoursRemaining = Math.max(0, Math.round((expiresAt - now) / (1000 * 60 * 60)));
            const daysRemaining = Math.floor(hoursRemaining / 24);
            
            if (daysRemaining > 0) {
                expiryInfo = `Expires in ${daysRemaining} day${daysRemaining > 1 ? 's' : ''}`;
            } else if (hoursRemaining > 0) {
                expiryInfo = `Expires in ${hoursRemaining} hour${hoursRemaining > 1 ? 's' : ''}`;
            } else {
                expiryInfo = 'Expiring soon';
            }
        }
        
        audioContainer.innerHTML = `
            <div class="audio-player-card">
                <h4><i class="fas fa-headphones"></i> Call Recording</h4>
                <audio controls preload="metadata">
                    <source src="${data.audio_url}" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <div class="recording-info">
                    <span><i class="fas fa-clock"></i> ${expiryInfo}</span>
                    <button class="btn btn-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.75rem;" onclick="deleteRecording()">
                        <i class="fas fa-trash-alt"></i> Delete Recording
                    </button>
                </div>
            </div>
        `;
        
    } catch (error) {
        audioContainer.innerHTML = `
            <div style="color: var(--text-muted); font-size: 0.875rem; padding: 0.5rem 0;">
                <i class="fas fa-exclamation-circle"></i> Could not load audio player
            </div>
        `;
    }
}

function deleteRecording() {
    document.getElementById('modalTitle').textContent = 'Delete Recording';
    document.getElementById('modalMessage').textContent = 'Are you sure you want to delete the audio recording? The call analysis data will be preserved.';
    document.getElementById('confirmDeleteBtn').onclick = confirmDeleteRecording;
    document.getElementById('deleteModal').style.display = 'flex';
}

function deleteCall() {
    document.getElementById('modalTitle').textContent = 'Delete Call';
    document.getElementById('modalMessage').textContent = 'Are you sure you want to delete this call? This will permanently remove all analysis data and the recording.';
    document.getElementById('confirmDeleteBtn').onclick = confirmDeleteCall;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

async function confirmDeleteRecording() {
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    try {
        const response = await fetch(`/api/calls/${callId}/recording`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete recording');
        }
        
        closeModal();
        
        // Reload audio player section
        document.getElementById('deleteRecordingBtn').style.display = 'none';
        const audioContainer = document.getElementById('audioPlayerContainer');
        if (audioContainer) {
            audioContainer.innerHTML = `
                <div style="color: var(--text-muted); font-size: 0.875rem; padding: 0.5rem 0;">
                    <i class="fas fa-check-circle" style="color: #10B981;"></i> Recording deleted successfully
                </div>
            `;
        }
        
    } catch (error) {
        alert('Failed to delete recording: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Delete';
    }
}

async function confirmDeleteCall() {
    const btn = document.getElementById('confirmDeleteBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
    
    try {
        const response = await fetch(`/api/calls/${callId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete call');
        }
        
        // Redirect to dashboard
        window.location.href = '/';
        
    } catch (error) {
        alert('Failed to delete call: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = 'Delete';
    }
}

// Close modal on outside click
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

function renderCallDetail(call) {
    document.getElementById('callId').textContent = `Call ID: ${call.call_id}`;
    
    const scoreColor = call.overall_percentage >= 80 ? '#10B981' : call.overall_percentage >= 60 ? '#F59E0B' : '#EF4444';
    const sentimentColor = {
        'Positive': '#10B981',
        'Neutral': '#6B7280',
        'Negative': '#EF4444',
        'Mixed': '#F59E0B'
    }[call.customer_sentiment.overall_sentiment] || '#6B7280';
    
    document.getElementById('callContent').innerHTML = `
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-icon score">
                    <i class="fas fa-star"></i>
                </div>
                <div class="stat-value" style="color: ${scoreColor}">${call.overall_percentage.toFixed(1)}%</div>
                <div class="stat-label">Overall Score (${call.total_score}/${call.max_score})</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon sentiment">
                    <i class="fas fa-smile"></i>
                </div>
                <div class="stat-value" style="color: ${sentimentColor}">${call.customer_sentiment.overall_sentiment}</div>
                <div class="stat-label">Customer Sentiment</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon ${call.customer_sentiment.urgency_level === 'High' ? 'escalation' : 'calls'}">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="stat-value">${call.customer_sentiment.urgency_level}</div>
                <div class="stat-label">Urgency Level</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon ${call.customer_sentiment.escalation_risk > 50 ? 'escalation' : 'score'}">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-value">${call.customer_sentiment.escalation_risk.toFixed(0)}%</div>
                <div class="stat-label">Escalation Risk</div>
            </div>
        </div>
        
        <!-- Audio Player Section -->
        <div id="audioPlayerContainer"></div>
        
        <div class="detail-grid">
            <div>
                <!-- Call Summary -->
                <div class="info-card fade-in" style="margin-bottom: 1.5rem;">
                    <div class="info-header">
                        <h3 class="info-title">Call Summary</h3>
                    </div>
                    <p style="line-height: 1.8; color: var(--text-secondary);">${call.call_summary}</p>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px;">
                            <span style="color: var(--text-muted); font-size: 0.75rem;">Intent</span>
                            <div style="font-weight: 500;">${call.customer_intent}</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px;">
                            <span style="color: var(--text-muted); font-size: 0.75rem;">Resolution</span>
                            <div style="font-weight: 500;">${call.resolution_status}</div>
                        </div>
                        <div style="background: var(--bg-secondary); padding: 0.75rem 1rem; border-radius: 8px;">
                            <span style="color: var(--text-muted); font-size: 0.75rem;">Follow-up</span>
                            <div style="font-weight: 500;">${call.follow_up_required ? 'Required' : 'Not Required'}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Transcription -->
                <div class="info-card fade-in" style="animation-delay: 0.1s; margin-bottom: 1.5rem;">
                    <div class="info-header">
                        <h3 class="info-title">Transcription</h3>
                        <span class="badge mixed">${call.language.toUpperCase()}</span>
                    </div>
                    <div class="transcription-box">${call.transcription}</div>
                </div>
                
                <!-- Score Breakdown -->
                <div class="info-card fade-in" style="animation-delay: 0.2s;">
                    <div class="info-header">
                        <h3 class="info-title">Score Breakdown</h3>
                    </div>
                    <div id="scoreChart" style="height: 350px;"></div>
                    
                    <table class="data-table" style="margin-top: 1rem;">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Question</th>
                                <th>Answer</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${call.question_scores.map(q => `
                                <tr>
                                    <td><span class="badge mixed">${q.category}</span></td>
                                    <td style="max-width: 300px;">${q.question}</td>
                                    <td>${q.answer}</td>
                                    <td>
                                        <span style="font-family: 'JetBrains Mono', monospace; color: ${q.score === q.max_score ? '#10B981' : q.score === 0 ? '#EF4444' : '#F59E0B'}">
                                            ${q.score}/${q.max_score}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div>
                <!-- Call Info -->
                <div class="info-card fade-in" style="margin-bottom: 1.5rem;">
                    <div class="info-header">
                        <h3 class="info-title">Call Information</h3>
                    </div>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-item-label">Agent</div>
                            <div class="info-item-value">${call.agent_name || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Agent ID</div>
                            <div class="info-item-value">${call.agent_id || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Customer</div>
                            <div class="info-item-value">${call.customer_name || 'Unknown'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Phone</div>
                            <div class="info-item-value">${call.customer_phone || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Call Date</div>
                            <div class="info-item-value">${new Date(call.call_date).toLocaleString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-item-label">Duration</div>
                            <div class="info-item-value">${Math.round(call.duration_seconds)}s</div>
                        </div>
                    </div>
                </div>
                
                <!-- Customer Sentiment -->
                <div class="info-card fade-in" style="animation-delay: 0.1s; margin-bottom: 1.5rem;">
                    <div class="info-header">
                        <h3 class="info-title">Customer Sentiment</h3>
                    </div>
                    <div id="sentimentGauge" style="height: 200px;"></div>
                    
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Opening Emotion</span>
                            <span>${call.customer_sentiment.call_opening_emotion}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Closing Emotion</span>
                            <span>${call.customer_sentiment.call_end_emotion}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: var(--text-muted);">Frustration</span>
                            <span>${call.customer_sentiment.frustration_indicator ? '‚ö†Ô∏è Yes' : '‚úÖ No'}</span>
                        </div>
                        <div style="margin-top: 1rem;">
                            <span style="color: var(--text-muted); font-size: 0.875rem;">Detected Emotions</span>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                ${call.customer_sentiment.emotions.map(e => `<span class="badge mixed">${e}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Behavior -->
                <div class="info-card fade-in" style="animation-delay: 0.2s; margin-bottom: 1.5rem;">
                    <div class="info-header">
                        <h3 class="info-title">Agent Behavior</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${Object.entries(call.agent_behavior).map(([key, value]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                <span style="text-transform: capitalize;">${key.replace('_', ' ')}</span>
                                <span style="color: ${value ? '#10B981' : '#EF4444'}">
                                    ${value ? '‚úì Yes' : '‚úó No'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Compliance & Risk -->
                <div class="info-card fade-in" style="animation-delay: 0.3s;">
                    <div class="info-header">
                        <h3 class="info-title">Compliance & Risk</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Fraud Suspected</span>
                            <span class="badge ${call.compliance_risk.fraud_suspected ? 'negative' : 'positive'}">
                                ${call.compliance_risk.fraud_suspected ? 'Yes' : 'No'}
                            </span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Compliance Risk</span>
                            <span class="badge ${call.compliance_risk.compliance_risk === 'low' ? 'positive' : call.compliance_risk.compliance_risk === 'medium' ? 'mixed' : 'negative'}">
                                ${call.compliance_risk.compliance_risk.toUpperCase()}
                            </span>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                            <span style="color: var(--text-muted); font-size: 0.75rem;">Assessment</span>
                            <p style="margin-top: 0.25rem; font-size: 0.875rem;">${call.compliance_risk.trust_justification}</p>
                        </div>
                    </div>
                </div>
                
                <!-- Key Issues -->
                ${call.key_issues && call.key_issues.length > 0 ? `
                <div class="info-card fade-in" style="animation-delay: 0.4s; margin-top: 1.5rem;">
                    <div class="info-header">
                        <h3 class="info-title">Key Issues Identified</h3>
                    </div>
                    <ul style="list-style: none; display: flex; flex-direction: column; gap: 0.5rem;">
                        ${call.key_issues.map(issue => `
                            <li style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px;">
                                <i class="fas fa-exclamation-circle" style="color: var(--warning);"></i>
                                ${issue}
                            </li>
                        `).join('')}
                    </ul>
                </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Render charts
    renderScoreChart(call.question_scores);
    renderSentimentGauge(call.customer_sentiment.escalation_risk);
    
    // Load audio player after content is rendered
    loadAudioPlayer();
}

function renderScoreChart(scores) {
    // Group scores by category
    const categories = {};
    scores.forEach(s => {
        if (!categories[s.category]) {
            categories[s.category] = { score: 0, max: 0 };
        }
        categories[s.category].score += s.score;
        categories[s.category].max += s.max_score;
    });
    
    const categoryNames = Object.keys(categories);
    const percentages = categoryNames.map(c => (categories[c].score / categories[c].max * 100).toFixed(1));
    
    Plotly.newPlot('scoreChart', [{
        type: 'bar',
        orientation: 'h',
        y: categoryNames,
        x: percentages,
        marker: {
            color: percentages.map(p => p >= 80 ? '#10B981' : p >= 60 ? '#F59E0B' : '#EF4444')
        },
        text: percentages.map(p => p + '%'),
        textposition: 'outside',
        textfont: { color: '#f8fafc' },
        hovertemplate: '<b>%{y}</b><br>Score: %{x}%<extra></extra>'
    }], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Outfit, sans-serif', color: '#94a3b8' },
        margin: { t: 10, r: 50, b: 40, l: 150 },
        xaxis: {
            title: 'Score (%)',
            range: [0, 110],
            gridcolor: '#2d2d3a'
        },
        yaxis: { tickfont: { size: 11 } }
    }, { displayModeBar: false, responsive: true });
}

function renderSentimentGauge(escalationRisk) {
    Plotly.newPlot('sentimentGauge', [{
        type: 'indicator',
        mode: 'gauge+number',
        value: escalationRisk,
        title: { text: 'Escalation Risk', font: { size: 14, color: '#94a3b8' } },
        number: { suffix: '%', font: { color: '#f8fafc' } },
        gauge: {
            axis: { range: [0, 100], tickcolor: '#2d2d3a' },
            bar: { color: escalationRisk > 60 ? '#EF4444' : escalationRisk > 30 ? '#F59E0B' : '#10B981' },
            bgcolor: '#1a1a24',
            borderwidth: 0,
            steps: [
                { range: [0, 30], color: 'rgba(16, 185, 129, 0.2)' },
                { range: [30, 60], color: 'rgba(245, 158, 11, 0.2)' },
                { range: [60, 100], color: 'rgba(239, 68, 68, 0.2)' }
            ],
            threshold: {
                line: { color: '#f8fafc', width: 2 },
                thickness: 0.75,
                value: escalationRisk
            }
        }
    }], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Outfit, sans-serif', color: '#f8fafc' },
        margin: { t: 40, r: 30, b: 20, l: 30 }
    }, { displayModeBar: false, responsive: true });
}

document.addEventListener('DOMContentLoaded', loadCallDetail);
</script>
{% endblock %}
